import{u as S,e as $,f as D,h as M,j as P}from"./index-BaNYJjjK.js";import{d as j,r as l,E as s}from"./.pnpm-fc_Lr1wI.js";const d=S(),q=j("fileListStore",()=>{const r=l(!1),a=l({surl:"",url:"",pwd:"",dir:"/",password:"",token:"",account_ids:""}),g=l(null),z=()=>{const i=a.value.dir.split("/");i.pop();const v=i.join("/");return v===""?"/":v},F=async()=>{if(!(!g.value||!await g.value.validate())){if(a.value.surl==="")return s.error("获取链接surl失败");try{u.value=[],r.value=!0;const i=await $(a.value);o.value=i.data,a.value.dir!=="/"&&o.value.list.unshift({category:-1,fs_id:0,isdir:1,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:z(),server_filename:"..",dlink:""}),s.success("获取文件列表成功")}finally{r.value=!1}}},n=l({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),o=l({uk:0,shareid:0,randsk:"",list:[]}),u=l([]),p=l([]),x=async(i,v=!1)=>{if(r.value){s.info("请勿重复点击~");return}const w=d.config.min_single_filesize,k=d.config.max_single_filesize;let c=[];if(i){const e=o.value.list.find(t=>t.fs_id===i);if(!e)s.error("获取文件信息失败");else if(e.size<w){s.error("文件过小不会被解析!");return}else if(e.size>k){s.error("文件过大不会被解析!");return}c=[i]}else{let e=u.value.filter(t=>t.isdir!==1);e.length!==u.value.length&&s.error("文件夹不会被解析!"),e=e.filter(t=>t.size>w),e.length!==u.value.length&&s.error("文件过小不会被解析!"),e=e.filter(t=>t.size<k),e.length!==u.value.length&&s.error("文件过大不会被解析!"),c=e.map(t=>t.fs_id)}if(c.length>d.config.max_once){s.error(`一次最多解析${d.config.max_once}个文件`);return}if(c.length===0){s.error("满足要求的文件数量为0");return}let f;try{r.value=!0;const e={uk:o.value.uk,shareid:o.value.shareid,randsk:o.value.randsk,fs_ids:c,password:a.value.password,token:a.value.token,url:a.value.url,surl:a.value.surl,dir:a.value.dir,pwd:a.value.pwd,account_ids:a.value.account_ids};if(n.value.hit_captcha){if(!n.value.vcode_str||!n.value.vcode_input){s.error("请先输入验证码");return}e.vcode_str=n.value.vcode_str,e.vcode_input=n.value.vcode_input}if(f=await D(e),f.data?s.success("解析成功,下载链接请下滑"):s.success("解析可能失败,请打开控制台查看是否存在报错"),n.value={hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""},v)return r.value=!1,await m(),f.data.map(t=>({...t,index:0}));p.value=f.data.map(t=>({...t,index:0}))}catch(e){const{code:t,message:L}=e;if(t&&L&&L.includes("验证码")){const y=await M({password:a.value.password});n.value={hit_captcha:!0,vcode_str:y.data.vcode,vcode_img:y.data.img,vcode_input:""}}}finally{r.value=!1,await m(),await d.getConfig(!1)}},h=l({group_name:"",count:0,size:0}),_=l(""),m=async()=>{try{r.value=!0;const i=await P({token:a.value.token});h.value=i.data,_.value=""}catch(i){_.value=i.message}finally{r.value=!1}};return{pending:r,fileList:o,getFileList:F,getFileListForm:a,getFileListFormRef:g,selectedRows:u,downloadLinks:p,getDownloadLinks:x,limitForm:h,getLimit:m,limitMessage:_,vcode:n}});export{q as u};
