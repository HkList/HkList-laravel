import{u as c,e as y,f as V,h as F,j as x}from"./index-BJ_J5BpX.js";const S=c(),$=Pinia.defineStore("fileListStore",()=>{const l=Vue.ref(!1),e=Vue.ref({surl:"",url:"",pwd:"",dir:"/",password:"",token:"",account_ids:""}),d=Vue.ref(null),L=()=>{const a=e.value.dir.split("/");a.pop();const o=a.join("/");return o===""?"/":o},P=async()=>{if(!(!d.value||!await d.value.validate())){if(e.value.surl==="")return ElementPlus.ElMessage.error("获取链接surl失败");try{n.value=[],l.value=!0;const a=await y(e.value);i.value=a.data,e.value.dir!=="/"&&i.value.list.unshift({category:-1,fs_id:0,isdir:1,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:L(),server_filename:"..",dlink:""}),ElementPlus.ElMessage.success("获取文件列表成功")}finally{l.value=!1}}},r=Vue.ref({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),i=Vue.ref({uk:0,shareid:0,randsk:"",list:[]}),n=Vue.ref([]),m=Vue.ref([]),M=async(a,o=!1)=>{var h,w;if(l.value){ElementPlus.ElMessage.info("请勿重复点击~");return}const p=c().config.min_single_file;let u=[];if(a){const s=i.value.list.find(t=>t.fs_id===a);if(!s)ElementPlus.ElMessage.error("获取文件信息失败");else if(s.size<p){ElementPlus.ElMessage.error("文件过小不会被解析!");return}u=[a]}else{let s=n.value.filter(t=>t.isdir!==1);s.length!==n.value.length&&ElementPlus.ElMessage.error("文件夹不会被解析!"),s=s.filter(t=>t.size>p),s.length!==n.value.length&&ElementPlus.ElMessage.error("文件过小不会被解析!"),u=s.map(t=>t.fs_id)}if(u.length>(((w=(h=c())==null?void 0:h.config)==null?void 0:w.max_once)??20)){ElementPlus.ElMessage.error(`一次最多解析${c().config.max_once}个文件`);return}if(u.length===0){ElementPlus.ElMessage.error("满足要求的文件数量为0");return}let g;try{l.value=!0;const s={uk:i.value.uk,shareid:i.value.shareid,randsk:i.value.randsk,fs_ids:u,password:e.value.password,token:e.value.token,url:e.value.url,surl:e.value.surl,dir:e.value.dir,pwd:e.value.pwd,account_ids:e.value.account_ids};if(r.value.hit_captcha){if(!r.value.vcode_str||!r.value.vcode_input){ElementPlus.ElMessage.error("请先输入验证码");return}s.vcode_str=r.value.vcode_str,s.vcode_input=r.value.vcode_input}if(g=await V(s),ElementPlus.ElMessage.success("解析成功,下载链接请下滑"),r.value={hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""},o)return l.value=!1,await f(),g.data.map(t=>({...t,index:0}));m.value=g.data.map(t=>({...t,index:0}))}catch(s){const{code:t,message:E}=s;if(t&&E&&E.includes("验证码")){const k=await F({password:e.value.password});r.value={hit_captcha:!0,vcode_str:k.data.vcode,vcode_img:k.data.img,vcode_input:""}}}finally{l.value=!1,await f(),await S.getConfig(!1)}},_=Vue.ref({group_name:"",count:0,size:0}),v=Vue.ref(""),f=async()=>{try{l.value=!0;const a=await x({token:e.value.token});_.value=a.data,v.value=""}catch(a){v.value=a.message}finally{l.value=!1}};return{pending:l,fileList:i,getFileList:P,getFileListForm:e,getFileListFormRef:d,selectedRows:n,downloadLinks:m,getDownloadLinks:M,limitForm:_,getLimit:f,limitMessage:v,vcode:r}});export{$ as u};
