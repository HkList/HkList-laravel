import{e as $,u as _,f as D,h as M,j as P}from"./index-CST4mpV2.js";import{d as j,r as l,E as s}from"./.pnpm-CdrKUIM1.js";const q=j("fileListStore",()=>{const i=l(!1),t=l({surl:"",url:"",pwd:"",dir:"/",password:"",token:""}),d=l(null),x=()=>{const r=t.value.dir.split("/");r.pop();const v=r.join("/");return v===""?"/":v},z=async()=>{if(!(!d.value||!await d.value.validate())){if(t.value.surl==="")return s.error("获取链接surl失败");try{u.value=[],i.value=!0;const r=await $(t.value);o.value=r.data,t.value.dir!=="/"&&o.value.list.unshift({category:-1,fs_id:0,isdir:1,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:x(),server_filename:"..",dlink:""}),s.success("获取文件列表成功")}finally{i.value=!1}}},n=l({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),o=l({uk:0,shareid:0,randsk:"",list:[]}),u=l([]),p=l([]),S=async(r,v=!1)=>{var k,L;if(i.value){s.info("请勿重复点击~");return}const w=_().config.min_single_file;let c=[];if(r){const e=o.value.list.find(a=>a.fs_id===r);if(!e){s.error("获取文件信息失败");return}if(e.size<w){s.error("文件过小不会被解析!");return}c=[r]}else{let e=u.value.filter(a=>a.isdir!==1);e.length!==u.value.length&&s.error("文件夹不会被解析!"),e=e.filter(a=>a.size>w),e.length!==u.value.length&&s.error("文件过小不会被解析!"),c=e.map(a=>a.fs_id)}if(c.length>(((L=(k=_())==null?void 0:k.config)==null?void 0:L.max_once)??20)){s.error(`一次最多解析${_().config.max_once}个文件`);return}if(c.length===0){s.error("满足要求的文件数量为0");return}let m;try{i.value=!0;const e={uk:o.value.uk,shareid:o.value.shareid,randsk:o.value.randsk,fs_ids:c,password:t.value.password,token:t.value.token,url:t.value.url,surl:t.value.surl,dir:t.value.dir,pwd:t.value.pwd};if(n.value.hit_captcha){if(!n.value.vcode_str||!n.value.vcode_input){s.error("请先输入验证码");return}e.vcode_str=n.value.vcode_str,e.vcode_input=n.value.vcode_input}if(m=await D(e),s.success("解析成功,下载链接请下滑"),n.value={hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""},v)return i.value=!1,await g(),m.data.map(a=>({...a,index:0}));p.value=m.data.map(a=>({...a,index:0}))}catch(e){const{code:a,message:y}=e;if(a&&y&&y.includes("验证码")){const F=await M({password:t.value.password});n.value={hit_captcha:!0,vcode_str:F.data.vcode,vcode_img:F.data.img,vcode_input:""}}}finally{i.value=!1,await g()}},h=l({group_name:"",count:0,size:0}),f=l(""),g=async()=>{try{i.value=!0;const r=await P({token:t.value.token});h.value=r.data,f.value=""}catch(r){f.value=r.message}finally{i.value=!1}};return{pending:i,fileList:o,getFileList:z,getFileListForm:t,getFileListFormRef:d,selectedRows:u,downloadLinks:p,getDownloadLinks:S,limitForm:h,getLimit:g,limitMessage:f,vcode:n}});export{q as u};
